version: 2

jobs:
  build:
    docker:
      - image: docker:17.07.0-ce-git

    steps:
      - checkout

      - setup_remote_docker:
          version: 17.07.0-ce

      - run: 
          name: Build image
          command: docker build -t drupal .

      - run:
          name: Test web stack
          command: |
            docker run -d --rm --name drupal drupal
            sleep 2
            docker exec drupal curl -s http://localhost:8080/ | grep 'PHP Version'
            docker stop drupal

      - run:
          name: Test Composer
          command: docker run --rm drupal composer -V

      - run:
          name: Test Drush
          command: docker run --rm drupal drush core-status

      - run:
          name: Test Terminus
          command: docker run --rm drupal terminus self:info

      - run:
          name: Push image to Docker Hub
          command: |
            REPO="digdep/drupal-base"
            TAG_PREFIX=$([ "$CIRCLE_BRANCH" = "master" ] && echo || echo "${CIRCLE_BRANCH}-")
            TAG_MAJOR="$REPO:${TAG_PREFIX}3"
            TAG_LATEST="$REPO:${TAG_PREFIX}latest"
            docker tag drupal "$TAG_MAJOR"
            docker tag drupal "$TAG_LATEST"
            docker login -u "$DOCKER_HUB_USERNAME" -p "$DOCKER_HUB_PASSWORD"
            docker push "$TAG_MAJOR"
            docker push "$TAG_LATEST"
